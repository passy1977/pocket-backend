# Apache HTTP Server Configuration for Pocket Backend
# This configuration provides reverse proxy, SSL termination, and load balancing

# Basic server configuration
ServerRoot "/etc/httpd"
Listen 80
Listen 443 ssl

# Load essential modules
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule headers_module modules/mod_headers.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule security2_module modules/mod_security2.so

# Basic settings
ServerName pocket-api.yourdomain.com
ServerAdmin admin@yourdomain.com
DocumentRoot "/var/www/html"
DirectoryIndex index.html

# Security settings
ServerTokens Prod
ServerSignature Off

# MIME types
TypesConfig /etc/mime.types

# Logging
ErrorLog logs/error_log
LogLevel warn

# Access log with comprehensive format
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined
CustomLog logs/access_log combined

# Directory security
<Directory />
    AllowOverride none
    Require all denied
</Directory>

<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Security headers (global)
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "DENY"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"

# Remove server information
Header unset Server
Header unset X-Powered-By

# Proxy configuration for Pocket Backend
ProxyPreserveHost On
ProxyRequests Off

# Define backend servers for load balancing
ProxyPass /balancer-manager !
ProxyPass /server-status !
ProxyPass /server-info !

# Pocket Backend cluster configuration
<Proxy balancer://pocket-cluster>
    # Primary backend server
    BalancerMember http://127.0.0.1:8081 route=backend1
    
    # Secondary backend server (uncomment for HA setup)
    # BalancerMember http://127.0.0.1:8082 route=backend2
    
    # Health check configuration
    ProxySet hcmethod GET
    ProxySet hcuri /actuator/health
    ProxySet hcinterval 30
    
    # Load balancing method
    ProxySet lbmethod byrequests
</Proxy>

# HTTP Virtual Host (redirect to HTTPS)
<VirtualHost *:80>
    ServerName pocket-api.yourdomain.com
    ServerAlias api.yourdomain.com
    
    # Security headers for HTTP
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    
    # Allow Let's Encrypt challenges
    RewriteCond %{REQUEST_URI} ^/.well-known/acme-challenge/
    RewriteRule ^(.*)$ - [L]
    
    # Health check endpoint (allow HTTP for load balancers)
    <Location "/health">
        ProxyPass http://127.0.0.1:8081/actuator/health
        ProxyPassReverse http://127.0.0.1:8081/actuator/health
    </Location>
</VirtualHost>

# HTTPS Virtual Host
<VirtualHost *:443>
    ServerName pocket-api.yourdomain.com
    ServerAlias api.yourdomain.com
    
    # SSL Configuration
    SSLEngine on
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # SSL Certificate paths (adjust for your certificates)
    SSLCertificateFile /etc/ssl/certs/pocket-api.crt
    SSLCertificateKeyFile /etc/ssl/private/pocket-api.key
    SSLCertificateChainFile /etc/ssl/certs/pocket-api-chain.crt
    
    # HSTS Header
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # API Routes
    <Location "/api/">
        # Proxy to backend cluster with load balancing
        ProxyPass balancer://pocket-cluster/api/
        ProxyPassReverse balancer://pocket-cluster/api/
        
        # Timeout settings
        ProxyTimeout 300
        
        # Headers for backend
        ProxyPreserveHost On
        ProxyAddHeaders On
        
        # Rate limiting (requires mod_evasive)
        # DOSHashTableSize 4096
        # DOSPageCount 2
        # DOSPageInterval 1
        # DOSSiteCount 50
        # DOSSiteInterval 1
        # DOSBlockingPeriod 600
        
        # CORS headers (if needed)
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Max-Age "3600"
        
        # Handle preflight requests
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Location>
    
    # Actuator endpoints (admin only)
    <Location "/actuator/">
        ProxyPass balancer://pocket-cluster/actuator/
        ProxyPassReverse balancer://pocket-cluster/actuator/
        
        # Restrict access to admin IPs
        <RequireAll>
            Require ip 127.0.0.1
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
            # Add your admin IPs here
        </RequireAll>
        
        # Basic authentication (optional)
        # AuthType Basic
        # AuthName "Admin Area"
        # AuthUserFile /etc/httpd/conf/.htpasswd
        # Require valid-user
    </Location>
    
    # Balancer manager (admin only)
    <Location "/balancer-manager">
        SetHandler balancer-manager
        <RequireAll>
            Require ip 127.0.0.1
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
        </RequireAll>
    </Location>
    
    # Server status (admin only)
    <Location "/server-status">
        SetHandler server-status
        <RequireAll>
            Require ip 127.0.0.1
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
        </RequireAll>
    </Location>
    
    # Static content serving (if needed)
    <Location "/static/">
        DocumentRoot /var/www/pocket-static
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
        
        # Compression
        <IfModule mod_deflate.c>
            SetOutputFilter DEFLATE
            SetEnvIfNoCase Request_URI \
                \.(?:gif|jpe?g|png)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI \
                \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
        </IfModule>
    </Location>
    
    # Error pages
    ErrorDocument 502 /errors/502.html
    ErrorDocument 503 /errors/503.html
    ErrorDocument 504 /errors/504.html
</VirtualHost>

# Security module configuration (if mod_security is available)
<IfModule mod_security2.c>
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyInMemoryLimit 131072
    SecRequestBodyLimitAction Reject
    SecPcreMatchLimit 1000
    SecPcreMatchLimitRecursion 1000
    
    # Temporary directory
    SecTmpDir /tmp/
    SecDataDir /tmp/
    
    # Basic rules
    SecRule ARGS "@detectSQLi" \
        "id:1001,phase:2,block,msg:'SQL Injection Attack Detected',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',severity:2"
    
    SecRule ARGS "@detectXSS" \
        "id:1002,phase:2,block,msg:'XSS Attack Detected',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',severity:2"
</IfModule>

# Performance tuning
StartServers 8
MinSpareServers 5
MaxSpareServers 20
ServerLimit 256
MaxRequestWorkers 256
ThreadsPerChild 25

# Keep alive settings
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# Compression
<IfModule mod_deflate.c>
    SetOutputFilter DEFLATE
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Cache control
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType application/json "access plus 1 hour"
</IfModule>